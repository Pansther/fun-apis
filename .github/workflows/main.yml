name: automation-deployment
run-name: ${{ github.actor }}
on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  # จะได้ชื่อ image เป็น ghcr.io/username/repo-name
  IMAGE_NAME: ${{ github.repository }}
    
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # จำเป็นสำหรับการ Build ข้ามสถาปัตยกรรม (x86 -> ARM64)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/arm64 
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          # ใช้ cache เพื่อให้การ build ครั้งต่อไปเร็วขึ้น
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PI_TAILSCALE_IP }}
          username: ${{ secrets.PI_USERNAME }}
          key: ${{ secrets.PI_SSH_KEY }}
          envs: GH_TOKEN
          script_stop: true
          script: |
            echo "$GH_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            docker stop fun-apis || true
            docker rm fun-apis || true
            docker run -d \
              --name fun-apis \
              -p 3001:3000 \
              --restart unless-stopped \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        env:
          GH_TOKEN: ${{ secrets.GH_READ_PACKAGES_TOKEN }}
